{% load django_vite %}
{% block js %}
    {% vite_asset 'js/styles/form-resources.css.js' %}
    {% vite_asset 'js/components/Resources/FormResource.js' %}
    {% vite_asset 'js/components/MultiSelectRegionDepartment.js' %}
    {% vite_asset 'js/components/RegionDepartmentPreparer.js' %}
    {% vite_asset 'js/apps/featureAddContact.js' %}
    {% vite_asset 'js/components/AjvValidationSchema.js' %}
{% endblock js %}
<!-- Form -->
<div x-data="AjvValidationSchema('schemaResourceFormValidator')">
    <form id="form-resource" x-ref="formResource" @submit.prevent="onSubmit">
        {% csrf_token %}
        <div x-data="FormResource({{ resource.id|default:'null'|safe }})"
             x-init="init()"
             class="create-resources"
             @modal-response="closeCreateContactModal($event)"
             @multi-select-change="resourceFormData.tags = $event.detail">
            <div class="d-flex justify-content-between">
                {% if edit_resource %}
                    <h2 class="create-resources__title text-modal-main-msg">Modification de fiche ressource</h2>
                {% else %}
                    <h2 class="create-resources__title text-modal-main-msg">Création de fiche ressource</h2>
                {% endif %}
                <div>
                    <button @click.prevent
                            data-bs-toggle="modal"
                            :data-bs-target="`#resource-preview-`+{{ resource.id|default:'null'|safe }}" role="button" class="fr-btn fr-btn--tertiary fr-btn--sm fr-mr-1w">Prévisualiser</button>
                    <button role="submit"
                            class="fr-btn fr-btn--primary fr-btn--sm fr-mr-1w"
                            @click="onSubmit">Sauvegarder</button>
                </div>
                {% include 'resources/resource/modal_resource.html' %}
            </div>
            <div class="fr-grid-row">
                <!-- Column 1 -->
                <div class="fr-col-8 fr-col-md-8 fr-col-sm-12 fr-pr-4w">
                    <!-- Title -->
                    <div class="fr-input-group" :class="formFields['title']?.className">
                        <label class="fr-label text-modal-main-msg" for="id_title">Titre</label>
                        <input type="text"
                               name="title"
                               class="fr-input"
                               id="id_title"
                               required
                               x-model="resourceFormData.title">
                        <template x-for="(error, index) in getFieldErrors('title')" :key="index">
                            <p class="fr-error-text" x-text="error"></p>
                        </template>
                    </div>
                    <!-- Subtitle -->
                    <div class="fr-input-group fr-mb-1w"
                         :class="formFields['subtitle']?.className">
                        <label class="fr-label text-modal-main-msg" for="id_subtitle">Sous-titre</label>
                        <input type="text"
                               name="subtitle"
                               class="fr-input"
                               id="id_subtitle"
                               required
                               x-model="resourceFormData.subtitle">
                        <template x-for="(error, index) in getFieldErrors('subtitle')" :key="index">
                            <p class="fr-error-text" x-text="error"></p>
                        </template>
                    </div>
                    <div class="create-resources__help-text fr-mb-3w">
                        <span class="fr-icon fr-icon-information-line fr-icon--sm"></span>
                        <p>
                            Affiché sur la page de la ressource, sur la liste des ressources, dans l’aperçu d’une recommandation avec ressource, dans l’email qui informe d’une nouvelle recommandation.
                        </p>
                    </div>
                    <!-- Summary -->
                    <div class="fr-input-group fr-mb-1w"
                         :class="formFields['summary']?.className">
                        <label class="fr-label text-modal-main-msg" for="id_summary">Résumé</label>
                        <input type="text"
                               name="summary"
                               class="fr-input"
                               id="id_summary"
                               required
                               x-model="resourceFormData.summary">
                        <template x-for="(error, index) in getFieldErrors('summary')" :key="index">
                            <p class="fr-error-text" x-text="error"></p>
                        </template>
                    </div>
                    <div class="create-resources__help-text fr-mb-3w">
                        <span class="fr-icon fr-icon-information-line fr-icon--sm"></span>
                        <p>Affiché uniquement sur la page de la ressource.</p>
                    </div>
                    <!-- Content with tiptap editor -->
                    <div class="fr-input-group" :class="formFields['content']?.className">
                        <label class="fr-label text-modal-main-msg" for="id_content">Contenu</label>
                        {% include "tools/editor.html" with model="resourceFormData.content" initial_content="resourceFormData.content.text" initial_content_js=True input_required=True %}
                        <template x-for="(error, index) in getFieldErrors('content')" :key="index">
                            <p class="fr-error-text" x-text="error"></p>
                        </template>
                    </div>
                </div>
                <!-- Column 2 -->
                <div class="fr-col-4 fr-col-md-4 fr-col-sm-12 "
                     @set-departments="resourceFormData.departments = $event.detail">
                    <!-- Status select -->
                    <div class="fr-input-group">
                        <label class="fr-label text-modal-main-msg" for="id_status">Statut de publication</label>
                        <div class="d-flex">
                            <button type="button"
                                    class="fr-btn w-50 justify-content-center"
                                    :class="resourceFormData.status !== 0 ? 'fr-btn--secondary' : ''"
                                    @click="resourceFormData.status = 0">Brouillon</button>
                            <button type="button"
                                    class="fr-btn w-50 justify-content-center"
                                    :class="resourceFormData.status !== 2 ? 'fr-btn--secondary' : ''"
                                    @click="resourceFormData.status = 2">Publié</button>
                        </div>
                    </div>
                    <!-- Category select -->
                    <div class="fr-input-group" :class="formFields['category']?.className">
                        <label class="fr-label text-modal-main-msg" for="id_category">Catégorie</label>
                        <select name="category"
                                id="id_category"
                                class="fr-select"
                                required
                                valueAsNumber
                                x-model="resourceFormData.category">
                            <option value="" selected disabled>Sélectionner une catégorie</option>
                            {% for category in categories %}
                                <option :data="JSON.stringify({id: {{ category.id }}, name: '{{ category.name }}'})"
                                        value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                        <template x-for="(error, index) in getFieldErrors('category')" :key="index">
                            <p class="fr-error-text" x-text="error"></p>
                        </template>
                    </div>
                    <!-- Keywords multi-select -->
                    <div class="fr-input-group create-resources__multi-select-container"
                         x-data="{selected : resourceFormData.tags}">
                        <label class="fr-label text-modal-main-msg" for="id_tags">Mots-clés</label>
                        {% include "tools/multi_select.html" with name="tags" id="id_tags" %}
                    </div>
                    <!-- Carrier structure -->
                    <div class="fr-input-group" :class="formFields['support_orga']?.className">
                        <label class="fr-label text-modal-main-msg" for="id_support_orga">Structure porteuse</label>
                        <input type="text"
                               name="support_orga"
                               class="fr-input"
                               id="id_support_orga"
                               x-model="resourceFormData.support_orga"
                               required>
                        <template x-for="(error, index) in getFieldErrors('support_orga')" :key="index">
                            <p class="fr-error-text" x-text="error"></p>
                        </template>
                    </div>
                    <!-- Departments/regions multiple select -->
                    <div x-data="{selectedDepartments: {{ selected_departments |default:'[]'|safe }}}">
                        <div class="fr-input-group multi-select-region"
                             :class="formFields['departments']?.className"
                             x-data="RegionDepartmentPreparer({ selectedDepartments: selectedDepartments })">
                            <label class="fr-label text-modal-main-msg" for="id_departments">Territoire</label>
                            <template x-if="objectsToSelect && objectsToSelect.length">
                                <div x-data="MultiSelectRegionDepartment({ selected: selectedDepartments, objectsToSelect: objectsToSelect, displayRegions: true })">
                                    {% include "tools/contacts/multi_select.html" with name="departments" id="id_departments" placeholder="Cherchez et sélectionnez vos départements et régions" label="none" display_regions=True %}
                                    <template x-for="dept in selectedDepartments" :key="dept">
                                        <input type="hidden" name="departments" :value="dept">
                                    </template>
                                    {% if form.departments.errors %}
                                        <div class="fr-error-text form-mandatory-element">{{ form.departments.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </template>
                            <template x-for="(error, index) in getFieldErrors('departments')" :key="index">
                                <p class="fr-error-text" x-text="error"></p>
                            </template>
                        </div>
                    </div>
                    <!-- Expires on date picker -->
                    <div class="fr-input-group" :class="formFields['expires_on']?.className">
                        <label class="fr-label text-modal-main-msg" for="id_expires_on">Date d'expiration</label>
                        <input type="date"
                               name="expires_on"
                               class="fr-input"
                               id="id_expires_on"
                               x-model="resourceFormData.expires_on"
                               required>
                        <template x-for="(error, index) in getFieldErrors('expires_on')" :key="index">
                            <p class="fr-error-text" x-text="error"></p>
                        </template>
                    </div>
                    <!-- Contacts component (multiple) -->
                    <!-- add contacts -->
                    <div class="fr-input-group"
                         x-data="SearchContactModal({searchbarOnly:true})">
                        <label class="fr-label text-modal-main-msg" for="id_contacts">Contacts</label>
                        <input type="hidden"
                               name="contacts"
                               id="id_contacts"
                               x-model="resourceFormData.contacts">
                        {% include "tools/contacts/searchbar_for_contacts.html" with dropdown_position="relative" add_contact="from_search" %}
                    </div>
                    <!-- display contacts -->
                    <div>
                        <template x-if="resourceFormData.contacts.length > 0">
                            <template x-for="contact in resourceFormData.contacts" :key="contact.id">
                                <div class="fr-mb-2w border-light-grey"
                                     x-data="{contact:contact,isOpenDeleteContact:null}">
                                     <div class="position-relative d-flex justify-content-end">
                                            <span class="fr-icon-delete-line top-right-corner cursor-pointer" aria-label="supprimer contact" @click="suppressContact(contact)"></span>
                                    </div>
                                    {% include "tools/contacts/contact_card.html" with full_width=true %}
                                </div>
                            </template>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
