{% extends "projects/project/detail.html" %}
{% load guardian_tags %}
{% load django_vite %}
{% load projects_extra %}
{% block title %}
    Conversation - {{ block.super }}
{% endblock title %}
{% block og_title %}
    Conversation - {{ block.super }}
{% endblock og_title %}
{% block js %}
    {% vite_asset 'js/styles/projects-conversations-new.css.js' %}
    {% vite_asset 'js/apps/conversationsNew.js' %}
    {% vite_asset 'js/apps/featureAddContact.js' %}
{% endblock js %}
{% block project_detail %}
    {{ project.pk|json_script:"djangoProjectId" }}
    {{ feed|json_script:"djangoFeed" }}
    {{ user_project_perms|json_script:"userProjectPerms" }}
    {% is_project_owner project request.user as is_project_owner %}
    {{ is_project_owner|json_script:"isProjectOwner" }}
    {{ request.user.first_name|json_script:"djangoCurrentUserFirstName" }}
    {{ request.user.last_name|json_script:"djangoCurrentUserLastName" }}
    {{ request.user.email|json_script:"djangoCurrentUserEmail" }}
    {{ request.user.id|json_script:"djangoCurrentUserId" }}
    {{ request.user.profile.organization.name|json_script:"djangoCurrentUserOrganizationName" }}
    {{ request.user.profile.organization_position|json_script:"djangoCurrentUserOrganizationPosition" }}
    {{ recipients|json_script:"djangoRecipients" }}
    {% include "projects/project/navigation.html" with conversations_new=True %}
    {% include "projects/project/fragments/project_banner/banner_wrapper.html" with part="open" %}
    {% regroup feed by topic as topic_list %}
    <div class="conversation-new d-flex"
         x-data="Conversations({{ project.id }}, {{ request.user.id }})">
        <div class="conversation-new__topics">
            <div class="justify-content-between">
                {% include "conversations/messages/fragments/conversation_topic.html" with topic_name=topic.grouper message_number=topic.list %}
            </div>
            <div class="conversation-new__topics-list-member fr-px-2w fr-pt-2w"
                 x-data="{isOpen: false}"
                 :class="{'open': isOpen}">
                <h2 class="conversation-new__topics-list-member-title">Participants</h2>
                <h3 class="fr-mt-2w conversation-new__topics-list-member-subtitle">Demandeurs</h3>
                <ul class="flex-column list-unstyled fr-mb-0">
                    {% for projectmember in project.projectmember_set.all %}
                        {% if projectmember.is_owner and projectmember.member.is_active %}
                            <li>{% include "user/user_card.html" with user=project.owner project_owner=True user_activity=True %}</li>
                        {% elif projectmember.member.is_active %}
                            <li>{% include "user/user_card.html" with user=projectmember.member user_activity=True %}</li>
                        {% endif %}
                    {% endfor %}
                </ul>
                <h3 class="fr-mt-2w conversation-new__topics-list-member-subtitle">Equipe de suivi</h3>
                <ul class="d-flex flex-column list-unstyled fr-mb-0">
                    {% for advisor in project.switchtender_sites.all %}
                        {% if advisor.switchtender.is_active %}
                            <li>{% include "user/user_card.html" with user=advisor.switchtender user_activity=True %}</li>
                        {% endif %}
                    {% endfor %}
                </ul>
                <div class="list-member-toggle position-sticky bottom-0 start-0 text-center w-100 fr-pb-0">
                    <button class="fr-btn fr-btn--sm fr-btn--secondary bg-white "
                            @click="!isOpen && trackSeeMoreParticipants(); isOpen = !isOpen;"
                            x-text="isOpen ? 'Voir moins' : 'Voir plus'"></button>
                </div>
            </div>
        </div>
        <template x-if="!messagesLoaded">
            <div class="position-relative w-100">
                <div x-transition
                     class="position-absolute w-100 h-100 d-flex justify-content-center align-items-center"
                     data-cy="loader">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Chargement des messages...</span>
                    </div>
                </div>
            </div>
        </template>
        <template x-if="messagesLoaded">
            <div class="conversation-new__container"
                 x-show="showMessages"
                 x-transition.opacity.duration.500ms
                 x-data="NotificationEater({{ project.id }})"
                 {% comment %}
                 @topic-switched.window="scrollToFirstNotification($event.detail)"
                 {% endcomment %}>
                {% get_obj_perms request.user for project as "user_project_perms" %}
                {% include "conversations/messages/fragments/conversations_new_feed.html" %}
                {% if "use_public_notes" in user_project_perms %}
                    <!-- Post message -->
                    <form class="form editor-form fr-px-3v fr-pr-12w"
                          @submit.prevent="sendFormMessage(message)"
                          enctype="multipart/form-data"
                          id="conversation-form">
                        {% csrf_token %}
                        <div class="message-form fr-my-3v bg-light border-form editor-form__container fr-input-group position-relative"
                             :class="{'focus': isEditorFocused || isEditorInEditMode || isEditorInReplyMode, 'edit-mode': isEditorInEditMode, 'reply-mode': isEditorInReplyMode}"
                             @click.outside="isEditorFocused = false"
                             data-test-id="tiptap-editor-container">
                            <template x-if="isEditorInEditMode">
                                <div class="edit-mode__message-container">
                                    <p class="fr-text--sm fr-mb-0">
                                        Vous êtes en train de modifier un message.
                                        <button class="fr-link edit-mode__button fr-text--sm"
                                                @click="toggleEditMode({ activateEditMode: false })">Annuler</button>
                                    </p>
                                </div>
                            </template>
                            <template x-if="isEditorInReplyMode">
                                <div class="reply-mode__message-container">
                                    <p class="fr-text--sm fr-mb-0">
                                        Vous êtes en train de répondre à un message.
                                        <button class="fr-link reply-mode__button fr-text--sm"
                                                @click="onClickCancelReply">Annuler</button>
                                    </p>
                                </div>
                            </template>
                            {% if not is_project_owner %}
                                {% include "tools/editor.html" with model="message" input_name=posting_form.content.name initial_content=posting_form.content.value|default:'' errors=posting_form.content.errors input_required=True can_add_reco=True next_url_add_reco="projects-project-detail-conversations" can_attach_files=True can_attach_contact=True show_send_button=True form_id="conversation-form" placeholder="Écrivez votre message ici. Ajoutez des fichiers, contacts ou une recommandation…" can_compress_editor=True %}
                            {% else %}
                                {% include "tools/editor.html" with model="message" input_name=posting_form.content.name initial_content=posting_form.content.value|default:'' errors=posting_form.content.errors input_required=True can_add_reco=False next_url_add_reco="projects-project-detail-conversations" can_attach_files=True can_attach_contact=False show_send_button=True form_id="conversation-form" placeholder="Écrivez votre message ici. Vous pouvez ajouter des fichiers." can_compress_editor=True %}
                            {% endif %}
                            <input type="hidden" name="contact" :value="message?.contact?.id">
                        </div>
                        {% for error in posting_form.content.errors %}<div class="text-danger text-end">{{ error }}</div>{% endfor %}
                        <label class="visually-hidden" for="input-project-content">{{ posting_form.content.label }}</label>
                        <input type="hidden" name="new" value="1">
                        {% comment %} <input type="hidden" name="topic_name" :value="valueTopicFormMessageSend"> {% endcomment %}
                        <div class="d-flex justify-content-end fr-mt-3v"></div>
                    </form>
                {% endif %}
            </div>
        </template>
        {% include "projects/project/onboarding_tutorial.html" %}
        {% include "conversations/messages/fragments/confirm_delete_message.html" %}
    </div>
    {% include "projects/project/fragments/project_banner/banner_wrapper.html" with part="close" %}
{% endblock project_detail %}
