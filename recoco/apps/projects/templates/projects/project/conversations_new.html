{% extends "projects/project/detail.html" %}
{% load guardian_tags %}
{% load sass_tags %}
{% load django_vite %}
{% block title %}
    Nouvelle conversation - {{ block.super }}
{% endblock title %}
{% block og_title %}
    Nouvelle conversation - {{ block.super }}
{% endblock og_title %}
{% block js %}
    {% vite_asset 'js/components/Task.js' %}
    {% vite_asset 'js/store/tasks.js' %}
    {% vite_asset 'js/store/tasksData.js' %}
    {% vite_asset 'js/components/TaskModal.js' %}
    {% vite_asset 'js/components/TaskStatusSwitcherConversations.js' %}
    {% vite_asset 'js/components/NotificationEater.js' %}
    {% vite_asset 'js/components/ConversationTopicSwitch.js' %}
{% endblock js %}
{% block css %}
    <link href="{% sass_src 'projects/css/conversations_new.scss' %}"
          rel="stylesheet"
          type="text/css">
{% endblock css %}
{% block project_detail %}
    {{ project.pk|json_script:"djangoProjectId" }}
    {% get_obj_perms request.user for project as "user_project_perms" %}
    {% include "projects/project/navigation.html" with conversation=True %}
    {% regroup feed by topic as topic_list %}
    <div class="conversation-new d-flex" x-data="ConversationTopicSwitch()">
        <div class="conversation-new__topics">
            <div class="conversation-new__header">
                <h3>Fils de discussion</h3>
            </div>
            {% for topic in topic_list %}
                {% include "projects/project/fragments/conversations_new/conversation_topic.html" with topic_name=topic.grouper message_number=topic.list %}
            {% endfor %}
        </div>
        <div class="conversation-new__container fr-p-5v"
             x-data="NotificationEater({{ project.id }})">
            <!-- Message stream -->
            {% for element in feed %}
                <div class="feed-element-item"
                     data-topic='{{ element.topic|default:"general"|slugify }}'>
                    {% if forloop.last %}<div class="d-hide" x-ref="scrollLineLastMessage"></div>{% endif %}
                    {% if element.notifications %}<hr class="notification-line" x-ref="scrollLine">{% endif %}
                    {% ifchanged element.timestamp|date %}
                        <p class="text-center">{{ element.timestamp|date }}</p>
                    {% endifchanged %}
                    {% if element.type == "activity" %}
                        <!-- Type Activity  -->
                        {% include "projects/project/fragments/conversations_new/message_type/type_activity_item.html" %}
                    {% elif element.type == "reco" %}
                        <!-- Type Reco + message -->
                        {% include "projects/project/fragments/conversations_new/message_type/type_task_message_item.html" %}
                    {% elif element.type == "followup" %}
                        <!-- Type followup -->
                        {% include "projects/project/fragments/conversations_new/message_type/type_followup_item.html" %}
                    {% elif element.type == "posting" %}
                        <!-- Type message -->
                        {% include "projects/project/fragments/conversations_new/message_type/type_posting_item.html" %}
                    {% endif %}
                </div>
            {% endfor %}
            {% if "use_public_notes" in user_project_perms %}
                <hr />
                <!-- Post message -->
                <div class="message-form fr-mt-3w fr-p-2w bg-light border-form">
                    <form class="form"
                          method="post"
                          action="{% url 'projects-conversation-create-message' project.pk %}"
                          enctype="multipart/form-data"
                          id="conversation-form">
                        {% csrf_token %}
                        {% include "tools/editor.html" with input_name=posting_form.content.name input_value=posting_form.content.value|default:'' input_required=True %}
                        <label class="visually-hidden" for="input-project-content">{{ posting_form.content.label }}</label>
                        {% for error in posting_form.content.errors %}<div class="text-danger text-end">{{ error }}</div>{% endfor %}
                        {% include "projects/project/fragments/files_links/file_upload_input_standalone.html" %}
                        <input type="hidden" name="new" value="1">
                        <div class="d-flex justify-content-end fr-mt-3w">
                            <button data-test-id="send-message-conversation"
                                    x-data
                                    :disabled="$store.editor.currentMessage === '' "
                                    form="conversation-form"
                                    class="fr-btn"
                                    type="submit">Envoyer</button>
                        </div>
                    </form>
                </div>
            {% endif %}
            {% include "projects/project/fragments/tasks_modal/feedback_modal.html" %}
        </div>
    </div>
{% endblock project_detail %}
