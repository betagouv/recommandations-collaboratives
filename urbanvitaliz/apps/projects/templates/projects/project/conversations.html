{% extends "projects/project/detail.html" %}

{% load static %}
{% load humanize %}
{% load gravatar %}

{% block title %}
{{ block.super }} > Conversations
{% endblock %}

{% block project_detail %}

<div class="col-12 mx-auto">


    <div class="row">

        <div class="col-12 col-lg-8">
            {% regroup project.notes.public by created_on.date as notes_by_day %}

            <div class="message-window flex-grow-1" style="overflow-y: auto; overflow-x: hidden; max-height: 40vh; display:flex; flex-direction:column-reverse;">
                <ul class="list-group">
                    {% for date, notes in notes_by_day|slice:":20" reversed %}
                    <li class="list-group-item border-0 m-0 p-0">
                        <div class="small my-2 text-center w-100 text-secondary">{{ date|naturalday|capfirst }}</div>
                        {% for note in notes reversed  %}
                        <div class="bg-light rounded-3 p-3 text-secondary my-1">
                            {{ note.content_rendered|safe }}
                            {% if note.created_by %}
                            <div>
                                <span class="align-items-center link-dark text-decoration-none">
                                    <img
                                        src="{% gravatar_url note.created_by.email 16 %}"
                                        alt="{{ note.created_by.get_full_name }}"
                                        class="me-1 rounded-circle"
                                        style="width: 16px; height: 16px;"
                                    />
                                </span>
                                <span class="align-middle small text-dark">
                                    {{ note.created_by.get_full_name|capfirst|default:note.created_by }}
                                </span>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </li>
                    {% endfor %}
                </ul>
            </div>

            {% if can_manage %}
            <hr/>

            <!-- Post message -->
            <div class="message-form">
                <form class="form border p-3 d-flex align-items-end flex-column"
                      method="POST"
                      action="{% url 'projects-conversation-create-message' project.pk %}">
                    {% csrf_token %}

                    <textarea class="flex-grow-1 border-0 form-control {% if public_note_form.content.errors %}is-invalid{% endif %}" style="height: 100px;" id="input-project-content" name="{{ public_note_form.content.name }}" value="{{ public_note_form.content.value|default:'' }}" placeholder="Entrez votre message."></textarea>
                    <label class="visually-hidden" for="input-project-content">{{ public_note_form.content.label }}</label>

                    {% for error in public_note_form.content.errors %}
                    <div class="text-danger text-end">{{ error }}</div>
                    {% endfor %}

                    <button class="btn mt-2 btn-primary flex-align-end" type="submit">Envoyer</button>
                </form>

            </div>
            {% endif %}
        </div>
        <div class="col mx-auto col-lg-4 col-md-12">
            <div class="mb-4">
                {% include "projects/project/fragments/sidebar.html" %}
            </div>
            

            <h6 class="mb-2">Les participant·e·s</h6>

            {% for recipient in recipients %}
            <div class="bg-light mt-3 p-4">
                <span class="align-items-center link-dark text-decoration-none">
                    <img
                        src="{% gravatar_url recipient.email 32 %}"
                        alt="{{ recipient.get_full_name }}"
                        class="me-2 rounded-circle"
                        style="width: 32px; height: 32px;"
                    />
                </span>
                <span class="align-middle">
                    <strong>{{ recipient.get_full_name|default:recipient.email }}</strong>
                    {% if recipient.profile.organization %}
                    - {{ recipient.profile.organization.name }}
                    {% elif recipient.email in project.emails %}
                    - {{ project.org_name|capfirst }}
                    {% endif %}
                </span>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}
