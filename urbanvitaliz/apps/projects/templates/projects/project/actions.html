{% extends "projects/project/detail.html" %}

{% load static %}
{% load humanize %}
{% load notifications_tags %}
{% load gravatar %}
{% load sass_tags %}

{% block js %}
<script src="{% static 'projects/js/board.js' %}"></script>
<script src="{% static 'projects/js/kanban_tasks.js' %}"></script>

<script src="https://cdn.jsdelivr.net/npm/js-md5@0.7.3/src/md5.min.js"></script>

<script type="text/javascript">
 const project_url_tmpl = "{% url 'projects-project-detail' 0 %}";
 function makeProjectURL(id) {
     return project_url_tmpl.replace('0', id);
 }

 function gravatar_url(email, size=50, name="Inconnu") {
     if (name.trim() == '') name = "Inconnu";

     hash = md5(email);
     encoded_fallback_uri = encodeURIComponent(`https://ui-avatars.com/api/${name}/${size}`);

     return `https://www.gravatar.com/avatar/${hash}?s=${size}&d=${encoded_fallback_uri}`
 }
</script>

<script src="{% static 'notifications/notify.js' %}" type="text/javascript"></script>
{% register_notify_callbacks callbacks='fill_notification_list,fill_notification_badge' %}

{% endblock %}


{% block css %}
<link href="{% sass_src 'projects/css/board.scss' %}" rel="stylesheet" type="text/css" />
{% endblock %}

{% block title %}
{{ block.super }} > Actions
{% endblock %}

{% block project_detail %}

<div class="col-12 mx-auto">

    {% include "projects/project/fragments/reminder_modal.html" %}

    <div class="row">
        <div class="col">
            <div class="d-flex mt-1 mb-4 align-items-center justify-content-between">
                {% if is_switchtender %}
                <h2 class="text-secondary text-uppercase fw-bolder mb-0" style="font-size: 12px;">
                    Actions proposées à la collectivité
                </h2>
                {% else %}
                <h2 class="mt-1 mb-4 text-secondary text-uppercase fw-bolder" style="font-size: 12px;">
                    Mes actions en cours
                </h2>
                {% endif %}

                <div class="d-flex align-items-center">
                    <div class="d-flex align-items-center ms-2">
                        <span class="text-muted me-2">Vos aiguilleurs :</span>
                        {% for switchtender in project.switchtenders.all %}
                        <img class="rounded-circle d-inline-block ms-1" width="20px" height="20px"
                            src="{% gravatar_url switchtender.email 25 %}" data-bs-toggle="tooltip" data-bs-placement="bottom"
                            title="{{ switchtender.get_full_name|default:'Aiguilleur inconnu' }}" style="z-index: 1000;" tabindex="0" />
                        {% endfor %}
                    </div>
    
                    {% if is_switchtender %}
                    <span class="ms-4">
                        <a class="btn btn-outline-primary w-100 btn-sm"  href="{% url 'projects-project-create-action' project.id %}">
                            <svg class="bi me-1" width="16" height="16" fill="currentColor">
                                <use xlink:href="{% static 'svg/bootstrap-icons.svg' %}#journal-plus"/>
                            </svg>
                            Ajouter une recommandation
                        </a>
                    </span>
                    {% endif %}
                </div>
            </div>


            <div x-data="boardTasksApp({{ project.id }})" x-init="getData()" class="d-flex pb-2 align-items-stretch">
                <template x-for="board in boards">
                    <div class="col px-2" style="min-height: 100px">
                        <div class="pb-4 rounded border-top border-4" :class="board.color_class">
                            <div class="d-flex justify-content-between justify-items-center px-2 py-2 bg-light sticky-top top-0">
                                <h5 x-text="board.title" class="fs-6 font-medium text-gray-800"></h5>
                            </div>

                            <div class="px-2 py-1 pb-1 bg-light shadow-sm">
                                <template x-if="column(board.status).length === 0">
                                    <div class="drag-targetable py-2" @dragover="onDragOver(event, null)" @drop="onDrop(event, board.status, null)" @dragenter="onDragEnter(event)" @dragleave="onDragLeave(event)">
                                        <div class="drag-placeholder"></div>
                                    </div>
                                </template>

                                <template x-for="(t, i) in column(board.status)" :key="t.id">
                                    <div>
                                        <div :id="t.uuid" class="drag-targetable py-2 my-2" @dragover="onDragOver(event)" @drop="onDrop(event, board.status, t.uuid)" @dragenter="onDragEnter(event)" @dragleave="onDragLeave(event)" >
                                            <div class="rounded bg-white shadow p-1 px-2 position-relative" draggable="true" @dragstart="onDragStart(event, t.uuid)" @dragend="onDragEnd(event)">
                                                <h6 class="mt-1 mb-0 fw-bold" x-text="truncate(t.intent)"></h6>
                                                <template x-if="t.resource_id">
                                                    <a @click="onPreviewClick(event, t.id)" style="font-size: 0.8em">Consulter la ressource</a>
                                                </template>

                                                <template x-if="!t.resource_id">
                                                    <a @click="onPreviewClick(event, t.id)" style="font-size: 0.8em">Voir la recommandation</a>
                                                </template>

                                                <div class="rounded bg-light p-2 my-2" style="font-size: 0.8em">
                                                    <p x-text="truncate(t.content, 200)" class="mb-2"></p>
                                                    <div>
                                                        <img class="align-middle rounded-circle d-inline-block" width="20px" height="20px"
                                                            :src="gravatar_url(t.created_by.email, 25, t.created_by.first_name + ' ' + t.created_by.last_name)"
                                                            data-bs-toggle="tooltip" data-bs-placement="bottom" :title="`${t.created_by.first_name} ${t.created_by.last_name}`"
                                                            style="z-index: 1000;" tabindex="0" />
                                                        <span class="ms-1 fst-italic" x-text="`${t.created_by.first_name} ${t.created_by.last_name}`"
                                                            style="line-height: 20px"></span>
                                                        </div>
                                                    </div>

                                                <div class="border-top py-1 d-flex align-middle justify-content-between" style="font-size: 0.8em">
                                                    <div class="d-flex align-items-center">
                                                        <div class="text-primary">
                                                            <svg class="aling-middle bi ms-1" width="16px" height="16px" fill="currentColor">
                                                                <use xlink:href="{% static 'svg/bootstrap-icons.svg' %}#chat"/>
                                                            </svg>
                                                            <span x-text="t.followups.length"></span>
                                                        </div>

                                                        <div class="text-primary ms-2">
                                                            <svg class="aling-middle bi ms-1" width="16px" height="16px" fill="currentColor">
                                                                <use xlink:href="{% static 'svg/bootstrap-icons.svg' %}#alarm"/>
                                                            </svg>
                                                            <span x-text="t.reminders.length"></span>
                                                        </div>
                                                    </div>

                                                    {% if can_administrate and not disable_edit %}
                                                    <div class="dropdown align-middle">
                                                        <a class="btn btn-sm btn-info dropdown-toggle" style="font-size: 0.8em;" href="#" role="button" id="dropdownMenuLink" data-bs-toggle="dropdown" aria-expanded="false">
                                                            Aiguillage
                                                        </a>
                                                        <ul class="dropdown-menu" aria-labelledby="dropdownMenuLink">
                                                            <li><a class="dropdown-item" :href="editTaskUrl(t.id)">Éditer</a></li>
                                                            <li>
                                                                <form method="POST" :action="deleteTaskReminderUrl(t.id)">
                                                                    {% csrf_token %}
                                                                    <button class="dropdown-item">Supprimer le rappel</button>
                                                                </form>
                                                            </li>
                                                        </ul>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>  
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </template>

                <div class="modal fade" id="task-preview" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-fullscreen">
                        <template x-if="currentTaskId" x-data="{ get currentTask() { return this.findById(this.currentTaskId) }  }">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h3 :text="currentTask.intent"></h3>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body p-0">
                                    <div class="d-flex align-items-stretch h-100" style="min-height: 85vh;">
                                        <div class="flex-fill p-3">
                                            <template x-if="currentTask.resource_id">
                                                <iframe class="w-100 h-100" :src="resourcePreviewUrl(currentTask.resource_id)"></iframe>
                                            </template>
                                            <template x-if="!currentTask.resource_id">
                                                <div class="col-10 px-5 mx-auto">
                                                    <div class="resource-details pb-3">
                                                        <h1 x-text="currentTask.intent" class="mb-3"></h1>
                                                    </div>
                                                    <p class="text-justified" x-text="currentTask.content"></p>
                                                </div>
                                            </template>
                                        </div>
                                        <div class="w-25 p-3 border border-top-0 border-bottom-0 border-right-0">
                                            <div class="d-flex flex-column justify-content-between h-100">      
                                                <div class="flex-fill">
                                                    <h2 class="text-secondary text-uppercase fw-bolder mb-0" style="font-size: 12px;">
                                                        <span class="align-middle">Conversation</span>
                                                    </h2>
                                                    <div class="overflow-x-auto">
                                                        <template x-for="f in currentTask.followups">
                                                            <div class="rounded bg-light p-2 my-2" style="font-size: 0.8em">
                                                                <p x-text="f.comment" class="mb-2"></p>
                                                                <div>
                                                                    <img class="align-middle rounded-circle d-inline-block" width="20px" height="20px"
                                                                        :src="gravatar_url(f.who.email, 25, f.who.first_name + ' ' + f.who.last_name)"
                                                                        data-bs-toggle="tooltip" data-bs-placement="bottom" :title="`${f.who.first_name} $f.who.last_name}`"
                                                                        style="z-index: 1000;" tabindex="0" />
                                                                    <span class="ms-1 fst-italic" x-text="`${f.who.first_name} ${f.who.last_name}`"
                                                                        style="line-height: 20px"></span>
                                                                    <span class="ms-1 text-muted" x-text="formatDate(f.timestamp)"
                                                                        style="line-height: 20px"></span>
                                                                </div>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </div>     
                                                <div>
                                                    <span>Répondre</span>
                                                    <form class="mt-2 form d-flex flex-column align-items-end" @submit.prevent="onSubmitComment">
                                                        {% csrf_token %}
                                                        <textarea name="comment" style="min-height: 100px; border-color: #ccc;" class="w-100 p-2 rounded rounded-4 my-1 border" placeholder="Votre message..." x-model="pendingComment"></textarea>
                                                        <button type="submit" class="btn btn-primary">Envoyer</button>
                                                    </form>
                                                </div>     
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
